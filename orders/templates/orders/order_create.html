{% extends "base.html" %}

{% block title %}Create Order | Vhojon Bilash POS{% endblock %}
{% block top_title %}Create Order{% endblock %}
{% block top_subtitle %}Create POS order with items and payments{% endblock %}

{% block content %}

<!-- ✅ Select2 + jQuery (required) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  :root{
    --vb-orange:#FFA609;
    --vb-green:#42AD36;
    --vb-ink:#0f172a;
  }

  /* Page feel */
  .vb-wrap{ position:relative; }
  .vb-wrap::before{
    content:"";
    position:absolute;
    inset:-24px -24px auto -24px;
    height:260px;
    border-radius:24px;
    background:
      radial-gradient(1000px 240px at 20% 0%, rgba(255,166,9,.25), transparent 60%),
      radial-gradient(900px 260px at 85% 10%, rgba(66,173,54,.22), transparent 60%),
      linear-gradient(90deg, rgba(255,166,9,.12), rgba(66,173,54,.12));
    z-index:0;
    pointer-events:none;
  }
  .vb-wrap > *{ position:relative; z-index:1; }

  /* Cards */
  .vb-card{
    background: rgba(255,255,255,.86);
    border:1px solid rgba(15,23,42,.08);
    border-radius:18px;
    box-shadow:
      0 18px 40px rgba(15,23,42,.08),
      0 2px 10px rgba(15,23,42,.04);
    backdrop-filter: blur(10px);
  }

  .vb-card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:18px 18px 12px 18px;
    border-bottom:1px solid rgba(15,23,42,.06);
  }
  .vb-title{
    font-size:1.05rem;
    font-weight:800;
    color:var(--vb-ink);
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    gap:.6rem;
  }
  .vb-badge{
    font-size:.72rem;
    padding:.2rem .55rem;
    border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    color:rgba(15,23,42,.75);
    background:linear-gradient(135deg, rgba(255,166,9,.16), rgba(66,173,54,.12));
  }

  /* Accent strip */
  .vb-accent-strip{
    height:3px;
    background:linear-gradient(90deg, var(--vb-orange), var(--vb-green));
    border-radius:999px;
    margin:0 18px 14px 18px;
  }

  /* Inputs */
  .vb-label{
    display:block;
    font-size:.78rem;
    font-weight:700;
    color:rgba(15,23,42,.8);
    margin-bottom:.35rem;
  }
  .vb-help{ font-size:.72rem; color:rgba(15,23,42,.55); }
  .vb-input :is(input,select,textarea){
    width:100%;
    border-radius:14px !important;
    border:1px solid rgba(15,23,42,.14) !important;
    background:rgba(255,255,255,.95) !important;
    padding:.62rem .8rem !important;
    outline:none !important;
    box-shadow:0 0 0 rgba(0,0,0,0) !important;
    transition: all .15s ease;
  }
  .vb-input :is(input,select,textarea):focus{
    border-color: rgba(66,173,54,.65) !important;
    box-shadow: 0 0 0 4px rgba(66,173,54,.14) !important;
  }
  .vb-input textarea{ min-height:74px; resize:vertical; }

  /* ✅ Select2 styling to match */
  .select2-container { width: 100% !important; }
  .select2-container .select2-selection--single{
    height: 42px !important;
    border-radius: 14px !important;
    border: 1px solid rgba(15,23,42,.14) !important;
    background: rgba(255,255,255,.95) !important;
    display:flex !important;
    align-items:center !important;
  }
  .select2-container--default .select2-selection--single .select2-selection__rendered{
    line-height: 42px !important;
    padding-left: 12px !important;
    color: rgba(15,23,42,.88) !important;
    font-weight: 700;
  }
  .select2-container--default .select2-selection--single .select2-selection__arrow{
    height: 42px !important;
    right: 10px !important;
  }
  .select2-container--open .select2-selection--single{
    border-color: rgba(66,173,54,.65) !important;
    box-shadow: 0 0 0 4px rgba(66,173,54,.14) !important;
  }
  .select2-dropdown{
    border-radius: 14px !important;
    overflow:hidden !important;
    border: 1px solid rgba(15,23,42,.14) !important;
  }

  /* Buttons */
  .vb-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    border-radius:14px;
    padding:.7rem 1rem;
    font-weight:800;
    font-size:.85rem;
    transition: all .15s ease;
    user-select:none;
  }
  .vb-btn-primary{
    color:white;
    background: linear-gradient(135deg, var(--vb-orange), #ff7b09);
    box-shadow: 0 12px 22px rgba(255,166,9,.25);
  }
  .vb-btn-primary:hover{ filter:brightness(1.02); transform: translateY(-1px); }
  .vb-btn-green{
    color:white;
    background: linear-gradient(135deg, var(--vb-green), #2f9f2b);
    box-shadow: 0 12px 22px rgba(66,173,54,.22);
  }
  .vb-btn-green:hover{ filter:brightness(1.02); transform: translateY(-1px); }
  .vb-btn-danger{
    color:white;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 12px 22px rgba(239,68,68,.18);
  }
  .vb-btn-danger:hover{ filter:brightness(1.02); transform: translateY(-1px); }

  /* Suggestions dropdown */
  .vb-suggestions{
    border:1px solid rgba(15,23,42,.12);
    border-radius:14px;
    overflow:hidden;
    background:white;
    box-shadow: 0 18px 40px rgba(15,23,42,.16);
  }
  .vb-suggest-btn{
    width:100%;
    text-align:left;
    padding:.6rem .85rem;
    font-size:.86rem;
    background:white;
  }
  .vb-suggest-btn:hover{
    background:linear-gradient(90deg, rgba(255,166,9,.10), rgba(66,173,54,.10));
  }

  /* Color blocks inside cards */
  .vb-pane{
    border:1px solid rgba(15,23,42,.08);
    border-radius:16px;
    background: linear-gradient(135deg, rgba(255,166,9,.12), rgba(66,173,54,.08));
  }
  .vb-pane-inner{
    border-radius:16px;
    background: rgba(255,255,255,.85);
    border:1px solid rgba(15,23,42,.06);
  }

  /* Order items: “table-card” layout */
  .vb-item{
    border-radius:18px;
    border:1px solid rgba(66,173,54,.22);
    background: linear-gradient(135deg, rgba(66,173,54,.12), rgba(255,166,9,.10));
    padding:14px;
  }
  .vb-item-inner{
    border-radius:16px;
    background: rgba(255,255,255,.88);
    border:1px solid rgba(15,23,42,.06);
    padding:14px;
  }
  .vb-item-grid{
    display:grid;
    grid-template-columns: 2.4fr .8fr 1.1fr 1.1fr 1.1fr;
    gap:12px;
    align-items:end;
  }
  @media (max-width:1024px){
    .vb-item-grid{ grid-template-columns: 1fr 1fr; }
  }

  /* Line total chip */
  .vb-line{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:12px;
  }
  .vb-line-chip{
    font-size:.78rem;
    font-weight:800;
    color:rgba(15,23,42,.85);
    padding:.4rem .7rem;
    border-radius:999px;
    background:linear-gradient(135deg, rgba(255,166,9,.16), rgba(66,173,54,.14));
    border:1px solid rgba(15,23,42,.08);
  }

  /* Summary box */
  .vb-summary{
    border-radius:18px;
    background: linear-gradient(135deg, rgba(255,166,9,.16), rgba(66,173,54,.14));
    border:1px solid rgba(15,23,42,.08);
    padding:14px;
  }
  .vb-summary-inner{
    border-radius:16px;
    background: rgba(255,255,255,.88);
    border:1px solid rgba(15,23,42,.06);
    padding:14px;
  }
  .vb-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:7px 0;
    font-size:.9rem;
  }
  .vb-row span:first-child{ color:rgba(15,23,42,.62); font-weight:650; }
  .vb-row span:last-child{ color:rgba(15,23,42,.88); font-weight:900; }
  .vb-hr{ border-top:1px dashed rgba(15,23,42,.18); margin:10px 0; }
  .vb-grand{
    font-size:1.25rem;
    font-weight:1000;
    color:rgba(15,23,42,.95);
  }
  .vb-due{ color:#dc2626 !important; }

  /* Submit message style */
  #submit-msg{
    padding:.55rem .8rem;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.85);
  }
</style>

<div class="vb-wrap space-y-6">

  <!-- TOP STRIP -->
  <div class="vb-card overflow-hidden">
    <div class="vb-accent-strip"></div>
    <div class="px-5 pb-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <div class="text-sm font-extrabold text-slate-900">New POS Order</div>
          <div class="text-xs text-slate-500">Create a professional order with items, discounts & payments.</div>
        </div>
      </div>
    </div>
  </div>

  <form id="order-form" method="post" class="space-y-6">
    {% csrf_token %}

    <!-- CUSTOMER -->
    <div class="vb-card">
      <div class="vb-card-header">
        <div class="vb-title">Customer <span class="vb-badge">Search & Autofill</span></div>
      </div>
      <div class="vb-accent-strip"></div>

      <div class="p-5">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

          <!-- Phone search -->
          <div class="vb-pane p-3">
            <div class="vb-pane-inner p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-extrabold text-slate-900">Phone Search</div>
                <span class="vb-badge">Type to suggest</span>
              </div>

              <div class="text-sm relative vb-input">
                <label class="vb-label" for="id_existing_phone">Phone Number</label>
                {{ cust_form.existing_phone }}

                <div id="phone-suggestions" class="hidden absolute z-20 mt-2 w-full vb-suggestions"></div>

                {% if cust_form.existing_phone.errors %}
                  <p class="text-red-600 text-xs mt-2">{{ cust_form.existing_phone.errors|striptags }}</p>
                {% endif %}
              </div>

              <p class="vb-help mt-3">
                Select an existing phone to auto-fill name & address. For new customer, fill manually.
              </p>
            </div>
          </div>

          <!-- Customer info -->
          <div class="vb-pane p-3">
            <div class="vb-pane-inner p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-extrabold text-slate-900">Customer Details</div>
                <span class="vb-badge">New / Existing</span>
              </div>

              <div class="grid grid-cols-1 gap-3 text-sm vb-input">
                <div>
                  <label class="vb-label" for="id_name">Name</label>
                  {{ cust_form.name }}
                  {% if cust_form.name.errors %}
                    <p class="text-red-600 text-xs mt-1">{{ cust_form.name.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="vb-label" for="id_phone">Phone</label>
                  {{ cust_form.phone }}
                  {% if cust_form.phone.errors %}
                    <p class="text-red-600 text-xs mt-1">{{ cust_form.phone.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="vb-label" for="id_address">Address</label>
                  {{ cust_form.address }}
                  {% if cust_form.address.errors %}
                    <p class="text-red-600 text-xs mt-1">{{ cust_form.address.errors|striptags }}</p>
                  {% endif %}
                </div>
              </div>

              {% if cust_form.non_field_errors %}
                <p class="text-red-600 text-xs mt-3">{{ cust_form.non_field_errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ORDER INFO + SUMMARY -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

      <!-- Order Info -->
      <div class="vb-card xl:col-span-2">
        <div class="vb-card-header">
          <div class="vb-title">Order Info <span class="vb-badge">Tax • Notes</span></div>
        </div>
        <div class="vb-accent-strip"></div>

        <div class="p-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm vb-input">
            <div>
              <label class="vb-label" for="{{ form.source.id_for_label }}">Source</label>
              {{ form.source }}
            </div>

            <div>
              <label class="vb-label" for="{{ form.status.id_for_label }}">Status</label>
              {{ form.status }}
            </div>

            <div>
              <label class="vb-label" for="{{ form.tax_amount.id_for_label }}">Tax Amount</label>
              {{ form.tax_amount }}
            </div>

            <div class="md:col-span-2">
              <label class="vb-label" for="{{ form.notes.id_for_label }}">Notes</label>
              {{ form.notes }}
            </div>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="vb-card">
        <div class="vb-card-header">
          <div class="vb-title">Order Summary <span class="vb-badge">Live</span></div>
        </div>
        <div class="vb-accent-strip"></div>

        <div class="p-5">
          <div class="vb-summary">
            <div class="vb-summary-inner">
              <div class="vb-row">
                <span>Items Subtotal</span>
                <span id="sum-subtotal">0.00</span>
              </div>

              <div class="vb-row">
                <span>Item Discounts</span>
                <span id="sum-item-discount">0.00</span>
              </div>

              <div class="vb-row">
                <span>Total Discount</span>
                <span id="sum-total-discount">0.00</span>
              </div>

              <div class="vb-row">
                <span>Tax</span>
                <span id="sum-tax">0.00</span>
              </div>

              <div class="vb-hr"></div>

              <div class="vb-row">
                <span class="text-slate-900 font-extrabold">Grand Total</span>
                <span id="sum-grand" class="vb-grand">0.00</span>
              </div>

              <div class="vb-hr"></div>

              <div class="vb-row">
                <span>Paid</span>
                <span id="sum-paid">0.00</span>
              </div>
              <div class="vb-row">
                <span class="text-slate-900 font-extrabold">Due</span>
                <span id="sum-due" class="vb-grand vb-due">0.00</span>
              </div>

              <p class="vb-help mt-2">
                * Live preview. Final totals saved by backend.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ORDER ITEMS -->
    <div class="vb-card">
      <div class="vb-card-header">
        <div class="vb-title">Order Items <span class="vb-badge">Cart</span></div>

        <button type="button" id="add-item-btn" class="vb-btn vb-btn-green">
          + Add Item
        </button>
      </div>
      <div class="vb-accent-strip"></div>

      <div class="p-5">
        {{ items_formset.management_form }}

        <div id="items-container" class="space-y-3">
          {% for f in items_formset %}
            <div class="vb-item order-item-row">
              <div class="vb-item-inner">
                <div class="vb-item-grid text-sm vb-input">
                  <div>
                    <label class="vb-label">Product</label>
                    {{ f.product }}
                  </div>

                  <div>
                    <label class="vb-label">Qty</label>
                    {{ f.qty }}
                  </div>

                  <div>
                    <label class="vb-label">Unit Price</label>
                    {{ f.unit_price }}
                  </div>

                  <div>
                    <label class="vb-label">Discount Type</label>
                    {{ f.discount_type }}
                  </div>

                  <div>
                    <label class="vb-label">Discount Value</label>
                    {{ f.discount_value }}
                  </div>
                </div>

                {% if f.DELETE %}
                  <div class="hidden">{{ f.DELETE }}</div>
                {% endif %}

                <div class="vb-line">
                  <span class="vb-line-chip">Line Total: <span class="line-total">0.00</span></span>
                  <button type="button" class="remove-item-btn vb-btn vb-btn-danger">Remove</button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Empty form template -->
        <template id="empty-item-template">
          <div class="vb-item order-item-row">
            <div class="vb-item-inner">
              <div class="vb-item-grid text-sm vb-input">
                <div>
                  {{ items_formset.empty_form.product.label_tag }}
                  {{ items_formset.empty_form.product }}
                </div>

                <div>
                  {{ items_formset.empty_form.qty.label_tag }}
                  {{ items_formset.empty_form.qty }}
                </div>

                <div>
                  {{ items_formset.empty_form.unit_price.label_tag }}
                  {{ items_formset.empty_form.unit_price }}
                  <p class="vb-help mt-1">Auto price</p>
                </div>

                <div>
                  {{ items_formset.empty_form.discount_type.label_tag }}
                  {{ items_formset.empty_form.discount_type }}
                </div>

                <div>
                  {{ items_formset.empty_form.discount_value.label_tag }}
                  {{ items_formset.empty_form.discount_value }}
                </div>
              </div>

              <div class="hidden">
                {{ items_formset.empty_form.DELETE }}
              </div>

              <div class="vb-line">
                <span class="vb-line-chip">Line Total: <span class="line-total">0.00</span></span>
                <button type="button" class="remove-item-btn vb-btn vb-btn-danger">Remove</button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- PAYMENTS -->
    <div class="vb-card" id="payments-card">
      <div class="vb-card-header">
        <div class="vb-title">Payments <span class="vb-badge">Paid / Reference</span></div>
      </div>
      <div class="vb-accent-strip"></div>

      <div class="p-5">
        {{ pay_formset.management_form }}

        <div class="space-y-3">
          {% for pf in pay_formset %}
            <div class="vb-pane p-3">
              <div class="vb-pane-inner p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm vb-input">
                  <div>
                    <label class="vb-label">Payment Method</label>
                    {{ pf.payment_method }}
                  </div>

                  <div>
                    <label class="vb-label">Amount</label>
                    {{ pf.amount }}
                  </div>

                  <div>
                    <label class="vb-label">Reference No</label>
                    {{ pf.reference_no }}
                  </div>
                </div>

                {% if pf.DELETE %}
                  <div class="hidden">{{ pf.DELETE }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- SUBMIT -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-end gap-3">
      <div id="submit-msg" class="text-sm"></div>

      <button type="submit" class="vb-btn vb-btn-primary min-w-[160px]">
        Create Order
      </button>
    </div>

  </form>
</div>

<script>
  const SUGGEST_URL  = "{% url 'customers:phone_suggest' %}";
  const AUTOFILL_URL = "{% url 'customers:customer_by_phone' %}";
  const PRICE_URL    = "{% url 'catalog:product_price' %}";

  // ✅ NEW: product search URL
  const PRODUCT_SEARCH_URL = "{% url 'orders:product_search' %}";

  const formEl = document.getElementById("order-form");
  const submitMsg = document.getElementById("submit-msg");

  const existingPhone = document.getElementById("id_existing_phone");
  const suggestionsBox = document.getElementById("phone-suggestions");

  const nameField = document.getElementById("id_name");
  const phoneField = document.getElementById("id_phone");
  const addressField = document.getElementById("id_address");

  // Summary fields
  const sumSubtotal = document.getElementById("sum-subtotal");
  const sumItemDiscount = document.getElementById("sum-item-discount");
  const sumTotalDiscount = document.getElementById("sum-total-discount");
  const sumTax = document.getElementById("sum-tax");
  const sumGrand = document.getElementById("sum-grand");
  const sumPaid = document.getElementById("sum-paid");
  const sumDue = document.getElementById("sum-due");

  const paymentsCardEl = document.getElementById("payments-card");

  let debounceTimer = null;

  function money(v) {
    const n = Number(v || 0);
    if (Number.isNaN(n)) return "0.00";
    return n.toFixed(2);
  }

  function hideSuggestions() {
    suggestionsBox.classList.add("hidden");
    suggestionsBox.innerHTML = "";
  }

  function showSuggestions(items) {
    if (!items.length) return hideSuggestions();
    suggestionsBox.innerHTML = items.map(item => `
      <button type="button" class="vb-suggest-btn" data-phone="${item.phone}">
        ${item.phone}
      </button>
    `).join("");
    suggestionsBox.classList.remove("hidden");
  }

  async function fetchSuggest(q) {
    const res = await fetch(`${SUGGEST_URL}?q=${encodeURIComponent(q)}`);
    return await res.json();
  }

  async function fetchAutofill(phone) {
    const res = await fetch(`${AUTOFILL_URL}?phone=${encodeURIComponent(phone)}`);
    return await res.json();
  }

  async function fetchPrice(productId) {
    const res = await fetch(`${PRICE_URL}?id=${encodeURIComponent(productId)}`);
    return await res.json();
  }

  // =========================================================
  // ✅ Select2 init for product search (works with formset rows)
  // =========================================================
  function initSelect2Products(scopeEl) {
    // scopeEl: row or document
    const $scope = scopeEl ? $(scopeEl) : $(document);

    $scope.find("select.js-product-search").each(function () {
      const $sel = $(this);

      // prevent duplicate init
      if ($sel.hasClass("select2-hidden-accessible")) return;

      $sel.select2({
        width: "100%",
        placeholder: "Search product...",
        allowClear: true,
        minimumInputLength: 2,
        ajax: {
          url: PRODUCT_SEARCH_URL,
          dataType: "json",
          delay: 250,
          data: function (params) {
            return {
              q: params.term || "",
              page: params.page || 1
            };
          },
          processResults: function (data, params) {
            params.page = params.page || 1;
            return {
              results: data.results || [],
              pagination: data.pagination || { more: false }
            };
          },
          cache: true
        }
      });
    });
  }

  // PHONE SEARCH + AUTO FILL
  existingPhone?.addEventListener("input", (e) => {
    const q = e.target.value.trim();
    if (phoneField) phoneField.value = q;

    if (q.length < 2) {
      hideSuggestions();
      return;
    }

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        const data = await fetchSuggest(q);
        showSuggestions(data.results || []);
      } catch {
        hideSuggestions();
      }
    }, 250);
  });

  suggestionsBox?.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-phone]");
    if (!btn) return;

    const phone = btn.dataset.phone;
    existingPhone.value = phone;
    if (phoneField) phoneField.value = phone;

    hideSuggestions();

    try {
      const data = await fetchAutofill(phone);
      if (data.found) {
        if (nameField) nameField.value = data.name || "";
        if (addressField) addressField.value = data.address || "";
      } else {
        if (nameField) nameField.value = "";
        if (addressField) addressField.value = "";
      }
    } catch {}
  });

  document.addEventListener("click", (e) => {
    if (!existingPhone?.contains(e.target) && !suggestionsBox?.contains(e.target)) {
      hideSuggestions();
    }
  });

  // ORDER ITEMS: Add/Remove + Price Autofill
  const itemsContainer = document.getElementById("items-container");
  const addItemBtn = document.getElementById("add-item-btn");
  const emptyItemTemplate = document.getElementById("empty-item-template");

  function totalFormsInput() {
    return document.querySelector("#id_items-TOTAL_FORMS");
  }

  function calcLine(row) {
    const del = row.querySelector("input[type='checkbox'][name$='-DELETE']");
    if (del && del.checked) return {sub:0, disc:0, total:0};

    const qty = Number(row.querySelector("input[name$='-qty']")?.value || 0);
    const price = Number(row.querySelector("input[name$='-unit_price']")?.value || 0);
    let sub = qty * price;

    const dtype = row.querySelector("select[name$='-discount_type']")?.value || "";
    const dval = Number(row.querySelector("input[name$='-discount_value']")?.value || 0);

    let disc = 0;
    if (dtype === "fixed") disc = Math.max(0, dval);
    if (dtype === "percent") disc = sub * Math.min(Math.max(dval, 0), 100) / 100;

    disc = Math.min(disc, sub);
    const total = Math.max(0, sub - disc);

    const lineEl = row.querySelector(".line-total");
    if (lineEl) lineEl.textContent = money(total);

    return {sub, disc, total};
  }

  function calcSummary() {
    let itemsSub = 0;
    let itemsDisc = 0;
    let itemsTotalAfterItemDisc = 0;

    document.querySelectorAll(".order-item-row").forEach(row => {
      const r = calcLine(row);
      itemsSub += r.sub;
      itemsDisc += r.disc;
      itemsTotalAfterItemDisc += r.total;
    });

    const tax = Number(document.getElementById("id_tax_amount")?.value || 0);
    const grand = Math.max(0, itemsTotalAfterItemDisc + tax);

    let paid = 0;
    paymentsCardEl?.querySelectorAll("input[name$='-amount']").forEach(inp => {
      paid += Number(inp.value || 0);
    });

    const due = Math.max(0, grand - paid);

    sumSubtotal.textContent = money(itemsSub);
    sumItemDiscount.textContent = money(itemsDisc);
    if (sumTotalDiscount) sumTotalDiscount.textContent = money(itemsDisc);
    sumTax.textContent = money(tax);
    sumGrand.textContent = money(grand);
    sumPaid.textContent = money(paid);
    sumDue.textContent = money(due);
  }

  function bindRowEvents(row) {
    const removeBtn = row.querySelector(".remove-item-btn");
    const deleteCheckbox = row.querySelector("input[type='checkbox'][name$='-DELETE']");

    removeBtn?.addEventListener("click", () => {
      // ✅ if select2 exists, destroy it to avoid memory leaks
      const sel = row.querySelector("select.js-product-search");
      if (sel && $(sel).hasClass("select2-hidden-accessible")) {
        $(sel).select2("destroy");
      }

      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        row.classList.add("hidden");
      } else {
        row.remove();
      }
      calcSummary();
    });

    const productSelect = row.querySelector("select[name$='-product']");
    const unitInput = row.querySelector("input[name$='-unit_price']");

    // ✅ When product changes (normal or select2)
    const onProductSelected = async () => {
      const pid = productSelect?.value;
      if (!pid) return;
      try {
        const data = await fetchPrice(pid);
        if (data.found && unitInput) unitInput.value = data.price;
      } catch {}
      calcSummary();
    };

    // normal change
    productSelect?.addEventListener("change", onProductSelected);

    // select2 selection event
    if (productSelect) {
      $(productSelect).on("select2:select", onProductSelected);
      $(productSelect).on("select2:clear", () => {
        calcSummary();
      });
    }

    ["input", "change", "keyup"].forEach(ev => {
      row.addEventListener(ev, (e) => {
        if (
          e.target.matches("input[name$='-qty']") ||
          e.target.matches("input[name$='-unit_price']") ||
          e.target.matches("select[name$='-discount_type']") ||
          e.target.matches("input[name$='-discount_value']")
        ) {
          calcSummary();
        }
      });
    });

    // ✅ init select2 for this row
    initSelect2Products(row);
  }

  // ✅ init select2 for initial rows
  initSelect2Products(document);

  document.querySelectorAll(".order-item-row").forEach(bindRowEvents);

  addItemBtn?.addEventListener("click", () => {
    const totalInput = totalFormsInput();
    const index = parseInt(totalInput.value, 10);

    const html = emptyItemTemplate.innerHTML.replaceAll("__prefix__", index);
    const wrapper = document.createElement("div");
    wrapper.innerHTML = html.trim();
    const newRow = wrapper.firstElementChild;

    itemsContainer.appendChild(newRow);
    totalInput.value = index + 1;

    // ✅ Important: init select2 + bind
    bindRowEvents(newRow);
    calcSummary();
  });

  ["input","change","keyup"].forEach(ev => {
    document.getElementById("id_tax_amount")?.addEventListener(ev, calcSummary);
  });

  paymentsCardEl?.addEventListener("input", (e) => {
    if (e.target.matches("input[name$='-amount']")) calcSummary();
  });

  calcSummary();

  // SUBMIT AS JSON (AJAX POST)
  formEl?.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitMsg.textContent = "Saving...";
    submitMsg.className = "text-sm";

    const formData = new FormData(formEl);

    try {
      const res = await fetch(window.location.href, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData
      });

      const contentType = res.headers.get("content-type") || "";
      let data = null;

      if (contentType.includes("application/json")) {
        data = await res.json();
      } else {
        const text = await res.text();
        console.error("Non-JSON response:", text);
        submitMsg.textContent = "Server error (not JSON). Check Django console.";
        submitMsg.className = "text-sm text-red-600";
        return;
      }

      if (!res.ok || !data.ok) {
        submitMsg.textContent = "Please fix form errors (check console).";
        submitMsg.className = "text-sm text-red-600";
        console.log("Validation errors:", data);
        return;
      }

      submitMsg.textContent = `✅ Order Created: ${data.order_no} | Due: ${data.due_total}`;
      submitMsg.className = "text-sm text-emerald-700 font-semibold";

      // ✅ ✅ NEW CHANGE: Redirect to Print Options page
      // expects backend to return: redirect_url
      // fallback: /orders/<id>/print/
      window.location.href = data.redirect_url || `/orders/${data.order_id}/print/`;

    } catch (err) {
      submitMsg.textContent = "Something went wrong. Check console.";
      submitMsg.className = "text-sm text-red-600";
      console.error(err);
    }
  });
</script>

{% endblock %}
